<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>å­¦åŠ›ã‚¢ãƒƒãƒ—æ²ç¤ºæ¿ã‚¢ãƒ—ãƒªï¼ˆå…¨éƒ¨å…¥ã‚Šï¼‰</title>
<style>
  body {
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    background: #f0fff4;
    color: #2a4d14;
    margin: 0;
    padding: 0;
  }

  header {
    background: #4caf50;
    color: white;
    padding: 1rem;
    text-align: center;
    font-weight: bold;
    font-size: 1.6rem;
    position: sticky;
    top: 0;
    z-index: 100;
  }

  #login-container,
  #app-container {
    max-width: 700px;
    margin: 1rem auto;
    background: white;
    border-radius: 8px;
    padding: 1rem 1.5rem;
    box-shadow: 0 0 8px rgba(0, 0, 0, 0.1);
  }

  input,
  select,
  textarea {
    width: 100%;
    padding: 8px;
    margin: 6px 0 12px 0;
    border: 1px solid #4caf50;
    border-radius: 4px;
    font-size: 1rem;
    box-sizing: border-box;
  }

  button {
    background: #4caf50;
    color: white;
    border: none;
    padding: 10px 1.8rem;
    margin: 6px 6px 6px 0;
    border-radius: 4px;
    cursor: pointer;
    font-size: 1rem;
  }

  button:hover:not(:disabled) {
    background: #388e3c;
  }

  button:disabled {
    background: #a5d6a7;
    cursor: not-allowed;
  }

  #login-message,
  #post-message,
  #reply-message,
  #search-message {
    color: red;
    margin-top: 0.5rem;
  }

  #welcome-msg {
    margin-bottom: 0.5rem;
    font-weight: bold;
  }

  #gear {
    position: fixed;
    top: 16px;
    right: 16px;
    font-size: 28px;
    cursor: pointer;
    color: #4caf50;
    user-select: none;
    z-index: 2000;
  }

  #side-panel {
    position: fixed;
    top: 0;
    right: -320px;
    width: 320px;
    height: 100vh;
    background: #e8f5e9;
    box-shadow: -4px 0 8px rgba(0, 0, 0, 0.15);
    padding: 1rem;
    transition: right 0.3s ease;
    overflow-y: auto;
    z-index: 1500;
  }

  #side-panel.open {
    right: 0;
  }

  #side-panel h3 {
    margin-top: 0;
    border-bottom: 1px solid #4caf50;
    padding-bottom: 0.5rem;
    color: #2a4d14;
  }

  #side-panel button {
    width: 100%;
    margin: 0.7rem 0;
    background: #4caf50;
  }

  #logout-btn {
    background: #c62828 !important;
  }

  #goal-text {
    background: #d0f0c0;
    border-radius: 4px;
    padding: 0.7rem;
    margin-bottom: 1rem;
    white-space: pre-wrap;
    font-size: 0.9rem;
  }

  #post-form,
  #reply-form,
  #search-form {
    margin-bottom: 1rem;
  }

  textarea {
    resize: vertical;
  }

  .post,
  .reply {
    border-bottom: 1px solid #ddd;
    padding: 0.8rem 0;
  }

  .post .content,
  .reply .content {
    white-space: pre-wrap;
    margin-bottom: 0.4rem;
  }

  .post-footer,
  .reply-footer {
    font-size: 0.85rem;
    color: #666;
  }

  .btn-good {
    cursor: pointer;
    color: #388e3c;
    font-weight: bold;
    margin-left: 1rem;
    user-select: none;
  }

  .btn-good.disabled {
    color: #388e3c;
    cursor: pointer;
  }

  .reply-container {
    margin-left: 2rem;
    margin-top: 0.5rem;
    border-left: 3px solid #4caf50;
    padding-left: 0.6rem;
    font-size: 0.9rem;
    color: #2a4d14;
  }

  .post-image,
  .reply-image {
    max-width: 200px;
    max-height: 120px;
    display: block;
    margin-top: 0.4rem;
    border-radius: 4px;
  }

  #filter-section {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    margin-bottom: 1rem;
  }

  #filter-section > * {
    flex: 1 1 150px;
  }

  .delete-btn {
    margin-left: 1rem;
    background: #c62828;
    color: #fff;
    border: none;
    padding: 4px 8px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.85rem;
  }

  .delete-btn:hover {
    background: #a72828;
  }
</style>
</head>
<body>

<header>å­¦åŠ›ã‚¢ãƒƒãƒ—æ²ç¤ºæ¿ã‚¢ãƒ—ãƒª</header>

<div id="login-container">
  <h2>ãƒ­ã‚°ã‚¤ãƒ³</h2>
  <input type="text" id="username" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼åï¼ˆæ–°è¦ç™»éŒ²æ™‚ã®ã¿ï¼‰" />
  <input type="email" id="email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" autocomplete="username" />
  <input type="password" id="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" autocomplete="current-password" />
  <button id="login-btn">ãƒ­ã‚°ã‚¤ãƒ³</button>
  <button id="signup-btn">æ–°è¦ç™»éŒ²</button>
  <p id="login-message"></p>
</div>

<div id="app-container" style="display:none;">
  <div id="gear" title="è¨­å®šâš™ï¸">âš™ï¸</div>

  <div id="welcome-msg"></div>

  <div id="goal-text" style="display:none;">
ã“ã‚“ã«ã¡ã¯ï¼ï¼ˆãƒ­ã‚°ã‚¤ãƒ³åï¼‰ã•ã‚“ï¼
ã“ã®webã‚¢ãƒ—ãƒªã¯å­¦æ ¡ã®å­¦åŠ›ã‚’ä¸Šã’ã‚‹ãŸã‚ã€åŠ©ã‘åˆã„ã€æ•™ãˆåˆã†æ²ç¤ºæ¿ã§ã™ã€‚
ã¿ã‚“ãªãŒå…±æœ‰ã—ã¦ã„ãŸã ãã¨ã‚ã‚ŠãŒãŸã„ã§ã™ã€‚
  </div>

  <div id="filter-section">
    <select id="subject-filter" title="æ•™ç§‘ã§çµã‚‹">
      <option value="">ã™ã¹ã¦ã®æ•™ç§‘</option>
      <option value="æ•°å­¦">æ•°å­¦</option>
      <option value="å›½èª">å›½èª</option>
      <option value="ç†ç§‘">ç†ç§‘</option>
      <option value="ç¤¾ä¼š">ç¤¾ä¼š</option>
      <option value="è‹±èª">è‹±èª</option>
      <option value="ãã®ä»–">ãã®ä»–</option>
    </select>
    <input type="text" id="search-input" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢" title="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢" />
    <button id="search-btn">æ¤œç´¢</button>
    <button id="reset-search-btn">ãƒªã‚»ãƒƒãƒˆ</button>
    <p id="search-message"></p>
  </div>

  <div id="post-form">
    <h3>æ–°ã—ã„æŠ•ç¨¿</h3>
    <select id="post-subject">
      <option value="æ•°å­¦">æ•°å­¦</option>
      <option value="å›½èª">å›½èª</option>
      <option value="ç†ç§‘">ç†ç§‘</option>
      <option value="ç¤¾ä¼š">ç¤¾ä¼š</option>
      <option value="è‹±èª">è‹±èª</option>
      <option value="ãã®ä»–">ãã®ä»–</option>
    </select>
    <textarea id="post-input" placeholder="è³ªå•ã‚„äºˆæƒ³å•é¡Œã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea><br />
    <input type="file" id="post-image-input" accept="image/*" />
    <button id="post-btn">æŠ•ç¨¿ã™ã‚‹</button>
    <p id="post-message"></p>
  </div>

  <div id="posts"></div>
</div>

<div id="side-panel" aria-hidden="true">
  <h3>è¨­å®šãƒ¡ãƒ‹ãƒ¥ãƒ¼</h3>
  <button id="toggle-goal-btn">ç›®æ¨™éè¡¨ç¤º</button>
  <button disabled>é‹å–¶ã¸ã®è³ªå•ãƒ»ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆæœªå®Ÿè£…ï¼‰</button>
  <button disabled>è¨­å®šï¼ˆæœªå®Ÿè£…ï¼‰</button>
  <button id="logout-btn" style="margin-top:2rem; background:#c62828;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<script>
  // ã“ã“ã‚’ã‚ãªãŸã®Firebaseè¨­å®šã«æ›¸ãæ›ãˆã¦ãã ã•ã„
  const firebaseConfig = {
  apiKey: "AIzaSyBfstQdl-avHfBWaiPkC0Bzwm_9apWe6Mo",
  authDomain: "school-board-e2ee2.firebaseapp.com",
  projectId: "school-board-e2ee2",
storageBucket: "school-board-e2ee2.appspot.com",
  messagingSenderId: "257360614407",
  appId: "1:257360614407:web:7cdae33b9ac7d7a671c6a2"
};


  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const storage = firebase.storage();

  // UIè¦ç´ å–å¾—
  const loginContainer = document.getElementById("login-container");
  const appContainer = document.getElementById("app-container");
  const loginMessage = document.getElementById("login-message");
  const welcomeMsg = document.getElementById("welcome-msg");
  const postInput = document.getElementById("post-input");
  const postBtn = document.getElementById("post-btn");
  const postsDiv = document.getElementById("posts");
  const gearBtn = document.getElementById("gear");
  const sidePanel = document.getElementById("side-panel");
  const toggleGoalBtn = document.getElementById("toggle-goal-btn");
  const goalText = document.getElementById("goal-text");
  const logoutBtn = document.getElementById("logout-btn");
  const postSubject = document.getElementById("post-subject");
  const postImageInput = document.getElementById("post-image-input");
  const subjectFilter = document.getElementById("subject-filter");
  const searchInput = document.getElementById("search-input");
  const searchBtn = document.getElementById("search-btn");
  const resetSearchBtn = document.getElementById("reset-search-btn");
  const searchMessage = document.getElementById("search-message");
  const postMessage = document.getElementById("post-message");

  let posts = [];
  let goalVisible = true;
  let openReplyForms = {};

  // ã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ«é–‹é–‰
  gearBtn.addEventListener("click", () => {
    if (sidePanel.classList.contains("open")) {
      sidePanel.classList.remove("open");
      sidePanel.setAttribute("aria-hidden", "true");
    } else {
      sidePanel.classList.add("open");
      sidePanel.setAttribute("aria-hidden", "false");
    }
  });

  // ç›®æ¨™è¡¨ç¤ºåˆ‡æ›¿
  toggleGoalBtn.addEventListener("click", () => {
    goalVisible = !goalVisible;
    goalText.style.display = goalVisible ? "block" : "none";
    toggleGoalBtn.textContent = goalVisible ? "ç›®æ¨™éè¡¨ç¤º" : "ç›®æ¨™è¡¨ç¤º";
  });

  // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
  logoutBtn.addEventListener("click", () => {
    auth.signOut();
  });

  // æŠ•ç¨¿è¡¨ç¤ºã‚’æç”»
  function renderPosts() {
    postsDiv.innerHTML = "";
    let filtered = posts.filter(post => {
      const matchSubject = subjectFilter.value === "" || post.subject === subjectFilter.value;
      const keyword = searchInput.value.trim().toLowerCase();
      const matchKeyword = keyword === "" || post.content.toLowerCase().includes(keyword) || post.userName.toLowerCase().includes(keyword);
      return matchSubject && matchKeyword;
    });
    filtered.sort((a,b) => (b.goodCount || 0) - (a.goodCount || 0) || (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
    filtered.forEach(post => {
      postsDiv.appendChild(createPostElement(post));
    });
  }

  // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
  function escapeHTML(str) {
    if (!str) return "";
    return str.replace(/[&<>"']/g, c => ({
      '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
    })[c]);
  }

  // æŠ•ç¨¿è¦ç´ ä½œæˆ
  function createPostElement(post) {
  const div = document.createElement("div");
  div.className = "post";
  div.dataset.id = post.id;

  // ã‚°ãƒƒãƒ‰ãƒœã‚¿ãƒ³ã®ã‚¯ãƒ©ã‚¹
  let goodClass = "btn-good";
  if (post.userGoodIds && post.userGoodIds.includes(auth.currentUser.uid)) goodClass += " active";

  // å‰Šé™¤ãƒœã‚¿ãƒ³ã¯è‡ªåˆ†ã®æŠ•ç¨¿ã®ã¿è¡¨ç¤º
  const canDelete = post.userId === auth.currentUser.uid;

  // HTMLçµ„ã¿ç«‹ã¦ï¼ˆã‚¨ã‚¹ã‚±ãƒ¼ãƒ—æ¸ˆã¿ï¼‰
  let html = `
    <div><strong>æ•™ç§‘ï¼š</strong>${escapeHTML(post.subject)}</div>
    <div class="content">${escapeHTML(post.content)}</div>
  `;

  if (post.imageUrl) {
    html += `<img src="${escapeHTML(post.imageUrl)}" alt="æŠ•ç¨¿ç”»åƒ" class="post-image">`;
  }

  html += `
    <div class="post-footer">
      æŠ•ç¨¿è€…: ${escapeHTML(post.userName)} | æ—¥æ™‚: ${post.createdAt ? new Date(post.createdAt.seconds * 1000).toLocaleString() : ""} | 
      <span class="${goodClass}" title="ã‚°ãƒƒãƒ‰" style="margin-left:1rem;">ğŸ‘ <span class="good-count">${post.goodCount || 0}</span></span>
      <button class="reply-btn" style="margin-left:1rem;">è¿”ä¿¡</button>
      ${canDelete ? `<button class="delete-btn" style="margin-left:1rem; background:#c62828; color:#fff; border:none; padding:4px 8px; border-radius:4px; cursor:pointer;">å‰Šé™¤</button>` : ""}
    </div>
    <div class="reply-container"></div>
  `;

  div.innerHTML = html;

  // ã‚°ãƒƒãƒ‰ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
  const goodBtn = div.querySelector(".btn-good");
  if (!goodBtn.classList.contains("disabled")) {
    goodBtn.addEventListener("click", () => toggleGood(post.id, null));
  }

  // è¿”ä¿¡ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
  const replyBtn = div.querySelector(".reply-btn");
  replyBtn.addEventListener("click", () => toggleReplyForm(post.id, div.querySelector(".reply-container")));

  // å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
  if (canDelete) {
    const deleteBtn = div.querySelector(".delete-btn");
    deleteBtn.addEventListener("click", async () => {
      if (!confirm("ã“ã®æŠ•ç¨¿ã¨è¿”ä¿¡ã‚’æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
      try {
        // è¿”ä¿¡ã‚‚å‰Šé™¤
        const repliesSnapshot = await db.collection("replies").where("postId", "==", post.id).get();
        const batch = db.batch();
        repliesSnapshot.forEach(doc => batch.delete(doc.ref));
        batch.delete(db.collection("posts").doc(post.id));
        await batch.commit();
        fetchPosts();
      } catch (e) {
        alert("å‰Šé™¤ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
        console.error(e);
      }
    });
  }

  // è¿”ä¿¡èª­ã¿è¾¼ã¿
  loadReplies(post.id, div.querySelector(".reply-container"));

  return div;
}


  // è¿”ä¿¡è¦ç´ ä½œæˆ
  function createReplyElement(reply, postId) {
  const div = document.createElement("div");
  div.className = "reply";
  div.dataset.id = reply.id;

  let goodClass = "btn-good";
  if (reply.userGoodIds && reply.userGoodIds.includes(auth.currentUser.uid)) goodClass += " disabled";

  // è‡ªåˆ†ã®è¿”ä¿¡ãªã‚‰å‰Šé™¤ãƒœã‚¿ãƒ³è¡¨ç¤º
  const canDelete = reply.userId === auth.currentUser.uid;

  let html = `
  <div class="content">${escapeHTML(reply.content)}</div>
`;
if (reply.imageUrl) {
  html += `<img src="${escapeHTML(reply.imageUrl)}" alt="è¿”ä¿¡ç”»åƒ" class="reply-image">`;
}

html += `
  <div class="reply-footer">
    æŠ•ç¨¿è€…: ${escapeHTML(reply.userName)} | æ—¥æ™‚: ${reply.createdAt ? new Date(reply.createdAt.seconds * 1000).toLocaleString() : ""}
    <span class="${goodClass}" title="ã‚°ãƒƒãƒ‰" style="margin-left:1rem;">ğŸ‘ <span class="good-count">${reply.goodCount || 0}</span></span>
    ${canDelete ? `<button class="delete-btn" style="margin-left:1rem; background:#c62828; color:#fff; border:none; padding:4px 8px; border-radius:4px; cursor:pointer;">å‰Šé™¤</button>` : ""}
  </div>
`;


  div.innerHTML = html;

  // ã‚°ãƒƒãƒ‰ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
  const goodBtn = div.querySelector(".btn-good");
if (goodBtn) {
  goodBtn.addEventListener("click", async () => {
    try {
      const replyDocRef = db.collection("replies").doc(reply.id);
      await db.runTransaction(async (transaction) => {
        const doc = await transaction.get(replyDocRef);
        if (!doc.exists) return;

        const data = doc.data();
        const goodIds = data.userGoodIds || [];
        let goodCount = data.goodCount || 0;

        if (goodIds.includes(auth.currentUser.uid)) {
          // å–ã‚Šæ¶ˆã—
          goodCount--;
          transaction.update(replyDocRef, {
            userGoodIds: goodIds.filter(id => id !== auth.currentUser.uid),
            goodCount
          });
        } else {
          // è¿½åŠ 
          goodCount++;
          transaction.update(replyDocRef, {
            userGoodIds: [...goodIds, auth.currentUser.uid],
            goodCount
          });
        }
      });
      fetchPosts();
    } catch (e) {
      console.error("ã‚°ãƒƒãƒ‰å¤±æ•—:", e);
    }
  });
}

  // å‰Šé™¤ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
  if (canDelete) {
    const deleteBtn = div.querySelector(".delete-btn");
    deleteBtn.addEventListener("click", async () => {
      if (!confirm("ã“ã®è¿”ä¿¡ã‚’æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
      try {
        await db.collection("replies").doc(reply.id).delete();
        fetchPosts();
      } catch (e) {
        alert("å‰Šé™¤ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
        console.error(e);
      }
    });
  }

  return div;
}


  // è¿”ä¿¡ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤ºãƒ»éè¡¨ç¤ºåˆ‡æ›¿
  function toggleReplyForm(postId, container) {
    if (openReplyForms[postId]) {
      openReplyForms[postId].remove();
      delete openReplyForms[postId];
      return;
    }

    const form = document.createElement("div");
    form.id = `reply-form-${postId}`;
    form.innerHTML = `
      <textarea placeholder="è¿”ä¿¡å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" rows="3" style="width:100%;"></textarea>
      <input type="file" accept="image/*" />
      <button>è¿”ä¿¡ã‚’é€ä¿¡</button>
      <p style="color:red;" class="reply-message"></p>
    `;

    container.appendChild(form);
    openReplyForms[postId] = form;

    const textarea = form.querySelector("textarea");
    const fileInput = form.querySelector("input[type=file]");
    const sendBtn = form.querySelector("button");
    const msgP = form.querySelector(".reply-message");

    sendBtn.addEventListener("click", async () => {
      const text = textarea.value.trim();
      if (!text) {
        msgP.textContent = "è¿”ä¿¡å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„";
        return;
      }
      sendBtn.disabled = true;
      msgP.textContent = "";

      try {
        let imageUrl = "";
        if (fileInput.files.length > 0) {
          const file = fileInput.files[0];
          const storageRef = storage.ref();
          const fileRef = storageRef.child(`replies/${postId}/${Date.now()}_${file.name}`);
          await fileRef.put(file);
          imageUrl = await fileRef.getDownloadURL();
        }
        await db.collection("replies").add({
          postId: postId,
          userId: auth.currentUser.uid,
          userName: auth.currentUser.displayName || auth.currentUser.email.split("@")[0],
          content: text,
          imageUrl: imageUrl,
          goodCount: 0,
          userGoodIds: [],
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        textarea.value = "";
        fileInput.value = "";
        msgP.textContent = "è¿”ä¿¡ã‚’é€ä¿¡ã—ã¾ã—ãŸ";
        form.remove();
        delete openReplyForms[postId];
        fetchPosts();
      } catch(e) {
        console.error(e);
        msgP.textContent = "é€ä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ";
      }
      sendBtn.disabled = false;
    });
  }

  // è¿”ä¿¡èª­ã¿è¾¼ã¿
  async function loadReplies(postId, container) {
    container.innerHTML = "è¿”ä¿¡ã‚’èª­ã¿è¾¼ã¿ä¸­...";
    try {
      const querySnapshot = await db.collection("replies")
        .where("postId", "==", postId)
        .orderBy("createdAt", "asc")
        .get();
      container.innerHTML = "";
      querySnapshot.forEach(doc => {
        const reply = {id: doc.id, ...doc.data()};
        container.appendChild(createReplyElement(reply, postId));
      });
    } catch(e) {
      container.innerHTML = "è¿”ä¿¡ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ";
      console.error(e);
    }
  }

  // ã‚°ãƒƒãƒ‰ãƒœã‚¿ãƒ³åˆ‡æ›¿ï¼ˆæŠ•ç¨¿orè¿”ä¿¡ï¼‰
  async function toggleGood(postId, replyId) {
    const uid = auth.currentUser.uid;
    let docRef;

    if (replyId === null) {
      docRef = db.collection("posts").doc(postId);
    } else {
      docRef = db.collection("replies").doc(replyId);
    }

    try {
      await db.runTransaction(async (transaction) => {
        const doc = await transaction.get(docRef);
        if (!doc.exists) throw "ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒå­˜åœ¨ã—ã¾ã›ã‚“";

        let docData = doc.data();
        let userGoodIds = docData.userGoodIds || [];
        let goodCount = docData.goodCount || 0;

        if (userGoodIds.includes(uid)) {
          userGoodIds = userGoodIds.filter(id => id !== uid);
          goodCount--;
        } else {
          userGoodIds.push(uid);
          goodCount++;
        }
        transaction.update(docRef, {
          userGoodIds: userGoodIds,
          goodCount: goodCount
        });
      });
      fetchPosts();
    } catch(e) {
      console.error("ã‚°ãƒƒãƒ‰æ›´æ–°ã‚¨ãƒ©ãƒ¼:", e);
    }
  }

  // æŠ•ç¨¿é€ä¿¡
  postBtn.addEventListener("click", async () => {
  const content = postInput.value.trim();
  const subject = postSubject.value;
  const file = postImageInput.files[0];
  postMessage.textContent = "";
  if (!content) {
    postMessage.textContent = "å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„";
    return;
  }
  postBtn.disabled = true;
  postMessage.style.color = "green";
  postMessage.textContent = "æŠ•ç¨¿ã‚’å‡¦ç†ä¸­ã§ã™â€¦ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„";

  try {
    let imageUrl = "";
    if (file) {
      const storageRef = storage.ref();
      const fileRef = storageRef.child(`posts/${auth.currentUser.uid}/${Date.now()}_${file.name}`);
      await fileRef.put(file);
      imageUrl = await fileRef.getDownloadURL();
    }

    await db.collection("posts").add({
      userId: auth.currentUser.uid,
      userName: auth.currentUser.displayName || auth.currentUser.email.split("@")[0],
      subject: subject,
      content: content,
      imageUrl: "",//ã„ã£ãŸã‚“ç”»åƒãªã—
      goodCount: 0,
      userGoodIds: [],
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    postInput.value = "";
    postImageInput.value = "";
    postMessage.textContent = "æŠ•ç¨¿ã•ã‚Œã¾ã—ãŸï¼";
  } catch(e) {
    console.error(e);
    postMessage.style.color = "red";
    postMessage.textContent = "æŠ•ç¨¿ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ";
  }
  postBtn.disabled = false;
  fetchPosts();
});


  // æŠ•ç¨¿å–å¾—
  async function fetchPosts() {
    try {
      const snapshot = await db.collection("posts").get();
      posts = [];
      snapshot.forEach(doc => {
        posts.push({id: doc.id, ...doc.data()});
      });
      renderPosts();
    } catch(e) {
      console.error(e);
    }
  }

  // æ¤œç´¢ã¨ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®ã‚¤ãƒ™ãƒ³ãƒˆ
  searchBtn.addEventListener("click", () => {
    searchMessage.textContent = "";
    renderPosts();
  });
  resetSearchBtn.addEventListener("click", () => {
    subjectFilter.value = "";
    searchInput.value = "";
    searchMessage.textContent = "";
    renderPosts();
  });
  subjectFilter.addEventListener("change", () => {
    renderPosts();
  });

  // èªè¨¼çŠ¶æ…‹ç›£è¦–
  auth.onAuthStateChanged(async (user) => {
  if (user) {
    // displayName ãŒãªã‘ã‚Œã°ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã•ã›ã‚‹
    if (!user.displayName) {
      const userName = prompt("ã“ã‚“ã«ã¡ã¯ï¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
      if (userName) {
        await user.updateProfile({ displayName: userName });
        // å†èª­ã¿è¾¼ã¿ã—ãªãã¦ã‚‚è¡¨ç¤ºæ›´æ–°
        welcomeMsg.textContent = `ã“ã‚“ã«ã¡ã¯ï¼${userName}ã•ã‚“ï¼`;
        goalText.innerHTML = `ã“ã‚“ã«ã¡ã¯ï¼${userName}ã•ã‚“ï¼<br>ã“ã®webã‚¢ãƒ—ãƒªã¯å­¦æ ¡ã®å­¦åŠ›ã‚’ä¸Šã’ã‚‹ãŸã‚ã€åŠ©ã‘åˆã„ã€æ•™ãˆåˆã†æ²ç¤ºæ¿ã§ã™ã€‚ã¿ã‚“ãªãŒå…±æœ‰ã—ã¦ã„ãŸã ãã¨ã‚ã‚ŠãŒãŸã„ã§ã™ã€‚`;
      }
    } else {
      welcomeMsg.textContent = `ã“ã‚“ã«ã¡ã¯ï¼${user.displayName}ã•ã‚“ï¼`;
      goalText.innerHTML = `ã“ã‚“ã«ã¡ã¯ï¼${user.displayName}ã•ã‚“ï¼<br>ã“ã®webã‚¢ãƒ—ãƒªã¯å­¦æ ¡ã®å­¦åŠ›ã‚’ä¸Šã’ã‚‹ãŸã‚ã€åŠ©ã‘åˆã„ã€æ•™ãˆåˆã†æ²ç¤ºæ¿ã§ã™ã€‚ã¿ã‚“ãªãŒå…±æœ‰ã—ã¦ã„ãŸã ãã¨ã‚ã‚ŠãŒãŸã„ã§ã™ã€‚`;
    }
    goalText.style.display = goalVisible ? "block" : "none";
    toggleGoalBtn.textContent = goalVisible ? "ç›®æ¨™éè¡¨ç¤º" : "ç›®æ¨™è¡¨ç¤º";
    loginContainer.style.display = "none";
    appContainer.style.display = "block";
    fetchPosts();
  } else {
    loginContainer.style.display = "block";
    appContainer.style.display = "none";
  }
});


  // ãƒ­ã‚°ã‚¤ãƒ³ãƒ»æ–°è¦ç™»éŒ²UIï¼ˆç°¡æ˜“ç‰ˆï¼‰
  const loginBtn = document.getElementById("login-btn");
  const signupBtn = document.getElementById("signup-btn");

  loginBtn.addEventListener("click", async () => {
    loginMessage.textContent = "";
    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value;
    if (!email || !password) {
      loginMessage.textContent = "ãƒ¡ãƒ¼ãƒ«ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„";
      return;
    }
    try {
      await auth.signInWithEmailAndPassword(email, password);
    } catch(e) {
      loginMessage.textContent = "ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—ï¼š" + e.message;
    }
  });

  signupBtn.addEventListener("click", async () => {
  loginMessage.textContent = "";
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value;
  const username = document.getElementById("username").value.trim();

  if (!email || !password || !username) {
    loginMessage.textContent = "ãƒ¡ãƒ¼ãƒ«ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’ã™ã¹ã¦å…¥åŠ›ã—ã¦ãã ã•ã„";
    return;
  }

  try {
    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
    await userCredential.user.updateProfile({
      displayName: username
    });
    alert("ç™»éŒ²å®Œäº†ï¼ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„");
  } catch(e) {
    loginMessage.textContent = "ç™»éŒ²å¤±æ•—ï¼š" + e.message;
  }
});

</script>
</body>
</html>
