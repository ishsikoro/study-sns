<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>å­¦åŠ›ã‚¢ãƒƒãƒ—æ²ç¤ºæ¿ã‚¢ãƒ—ãƒªï¼ˆå…¨éƒ¨å…¥ã‚Šï¼‰</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
<style>
  /* ãƒ™ãƒ¼ã‚¹è¨­å®š */
  body {
    font-family: "Inter", "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    background: #f0fff4;
    color: #2a4d14;
    margin: 0;
    padding: 0;
  }

  header {
    background: #4caf50;
    color: white;
    padding: 1rem;
    text-align: center;
    font-weight: bold;
    font-size: 1.6rem;
    position: sticky;
    top: 0;
    z-index: 100;
  }

  /* é€šå¸¸ï¼ˆPCç”¨ï¼‰ã‚¹ã‚¿ã‚¤ãƒ« */
    #icon-preview {
      width: 80px;
      height: 80px;
      border-radius: 50%;
    }

    /* â–¼ ã‚¹ãƒãƒ›å¯¾å¿œï¼ˆç”»é¢å¹…ãŒ600pxä»¥ä¸‹ã®ã¨ãï¼‰ */
    @media (max-width: 600px) {
      #icon-preview {
        width: 50px;
        height: 50px;
      }
    }

  #login-container,
  #app-container {
    max-width: 700px;
    margin: 1rem auto;
    background: white;
    border-radius: 12px;
    padding: 1rem 1.5rem;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
    transition: box-shadow 0.3s ease;
  }

  #login-container:hover,
  #app-container:hover {
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
  }

  /* å…¥åŠ›ãƒ»ãƒœã‚¿ãƒ³å…±é€šè¨­å®š */
  input,
  select,
  textarea,
  button {
    font-size: 1rem;
    box-sizing: border-box;
  }

  input,
  select,
  textarea {
    width: 100%;
    padding: 8px;
    margin: 6px 0 12px;
    border: 1px solid #4caf50;
    border-radius: 4px;
  }

  textarea {
    resize: vertical;
  }

  button {
    background: #4caf50;
    color: white;
    border: none;
    padding: 10px 1.8rem;
    margin: 6px 6px 6px 0;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.3s ease;
  }

  button:hover:not(:disabled) {
    background: #388e3c;
  }

  button:disabled {
    background: #a5d6a7;
    cursor: not-allowed;
  }

  /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ»ãƒ•ã‚©ãƒ¼ãƒ  */
  #login-message,
  #post-message,
  #reply-message,
  #search-message {
    color: red;
    margin-top: 0.5rem;
  }

  #goal-text {
    background: #d0f0c0;
    border-radius: 4px;
    padding: 0.7rem;
    margin-bottom: 1rem;
    white-space: pre-wrap;
    font-size: 0.9rem;
  }

  /* æŠ•ç¨¿ãƒ»è¿”ä¿¡ãƒ»å‰Šé™¤ */
  .post, .reply {
    border-bottom: 1px solid #ddd;
    padding: 0.8rem 0;
    animation: fadeInUp 0.5s ease forwards;
  }

  .post .content,
  .reply .content {
    white-space: pre-wrap;
    margin-bottom: 0.4rem;
  }

  .post-footer,
  .reply-footer {
    font-size: 0.85rem;
    color: #666;
  }

  .delete-btn {
    margin-left: 1rem;
    background: #c62828;
    color: #fff;
    border: none;
    padding: 4px 8px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.85rem;
    transition: background 0.3s ease;
  }

  .delete-btn:hover {
    background: #a72828;
  }

  .btn-good {
    cursor: pointer;
    color: #388e3c;
    font-weight: bold;
    margin-left: 1rem;
    user-select: none;
  }

  .btn-good.disabled {
  color: #ccc;
  cursor: not-allowed;
}

  button:active,
  .btn-good:active,
  .delete-btn:active {
    transform: scale(0.95);
    transition: transform 0.1s ease;
  }

  /* ã‚«ãƒ†ã‚´ãƒªãƒãƒƒã‚¸ */
  .badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: bold;
    margin-left: 0.5rem;
    color: white;
  }
  .badge.math { background: #2196f3; }
  .badge.english { background: #ff9800; }
  .badge.science { background: #673ab7; }
  .badge.history { background: #795548; }

  /* ç”»åƒãƒ»è¿”ä¿¡æ  */
  .post-image,
  .reply-image {
    max-width: 200px;
    max-height: 120px;
    display: block;
    margin-top: 0.4rem;
    border-radius: 4px;
  }

  .reply-container {
    margin-left: 1rem;
    margin-top: 0.5rem;
    border-left: 3px solid #4caf50;
    padding-left: 0.6rem;
    font-size: 0.9rem;
    color: #2a4d14;
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(15px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* ã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ« */
  #gear {
    position: fixed;
    top: 16px;
    right: 16px;
    font-size: 28px;
    cursor: pointer;
    color: #4caf50;
    user-select: none;
    z-index: 2000;
  }

  #side-panel {
    position: fixed;
    top: 0;
    right: -320px;
    width: 320px;
    height: 100vh;
    background: #e8f5e9;
    box-shadow: -4px 0 8px rgba(0, 0, 0, 0.15);
    padding: 1rem;
    transition: right 0.3s ease;
    overflow-y: auto;
    z-index: 1500;
  }

  #side-panel.open {
    right: 0;
  }

  #side-panel h3 {
    margin-top: 0;
    border-bottom: 1px solid #4caf50;
    padding-bottom: 0.5rem;
    color: #2a4d14;
  }

  #side-panel button {
    width: 100%;
    margin: 0.7rem 0;
    background: #4caf50;
  }

  #logout-btn {
    background: #c62828 !important;
  }

  /* ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ */
  #filter-section {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    margin-bottom: 1rem;
  }

  #filter-section > * {
    flex: 1 1 150px;
  }

  /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ */
  body.dark-mode {
    background: #121212;
    color: #f0f0f0;
  }

  body.dark-mode header {
    background: #1e1e1e;
    color: #ffffff;
  }

  body.dark-mode #login-container,
  body.dark-mode #app-container {
    background: #1e1e1e;
    color: #f0f0f0;
    box-shadow: 0 0 8px rgba(255, 255, 255, 0.05);
  }

  body.dark-mode input,
  body.dark-mode select,
  body.dark-mode textarea {
    background: #222;
    color: #fff;
    border: 1px solid #4caf50;
  }

  body.dark-mode button {
    background: #388e3c;
  }

  body.dark-mode #goal-text {
    background: #2e4d2c;
    color: #f0f0f0;
  }

  body.dark-mode .reply-container {
    border-left: 3px solid #81c784;
  }

  body.dark-mode .post,
  body.dark-mode .reply {
    border-bottom: 1px solid #444;
  }

  body.dark-mode #side-panel {
    background: #1b1b1b;
  }

  /* æŠ•ç¨¿è€…åã«è‰²ã¨ã‚¢ã‚¤ã‚³ãƒ³ */
  .post-user-name {
    font-weight: bold;
    padding-left: 24px;
    position: relative;
    display: inline-block;
    cursor: default;
  }

  .post-user-name::before {
    content: "";
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background-color: #4caf50;
    position: absolute;
    left: 0;
    top: 50%;
    transform: translateY(-50%);
  }

  .post-user-name.self {
    color: #2e7d32;
  }

  .post-user-name.self::before {
    background-color: #1b5e20;
  }

  .reply-count {
      font-size: 0.85rem;
      color: #555;
      margin-left: 1rem;
      cursor: pointer;
    }
    .hidden {
      display: none;
    }

    /* ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚«ãƒ¼ãƒ‰ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’ 3 åˆ—å›ºå®šã®ã‚°ãƒªãƒƒãƒ‰ã« */
#ranking-cards {
  display: grid;
  /* 3 åˆ—ã‚’å¿…ãšå‡ç­‰å¹…ã«ã€‚minmax(0,1fr) ãŒã‚«ã‚® */
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap: 0.8rem;
}


/* å€‹ã€…ã®ã‚«ãƒ¼ãƒ‰ã‚’å°‘ã—å°ã•ã‚ã«ã—ã€é«˜ã•è‡ªå‹•ã§ãã‚ãˆã‚‹ */
.ranking-card {
  background: #e8f5e9;
  border: 2px solid #4caf50;
  border-radius: 10px;
  padding: 0.8rem;
  font-size: 0.9rem;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
}

    
</style>
</head>
<body>


<header>å­¦åŠ›ã‚¢ãƒƒãƒ—æ²ç¤ºæ¿ã‚¢ãƒ—ãƒª</header>

<div id="login-container">
  <h2>ãƒ­ã‚°ã‚¤ãƒ³</h2>
  <input type="text" id="username" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼åï¼ˆæ–°è¦ç™»éŒ²æ™‚ã®ã¿ï¼‰" />
  <input type="email" id="email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" autocomplete="username" />
  <input type="password" id="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" autocomplete="current-password" />
  <button id="login-btn">ãƒ­ã‚°ã‚¤ãƒ³</button>
  <button id="signup-btn">æ–°è¦ç™»éŒ²</button>
  <p id="login-message"></p>
</div>

<div id="profile-setup" style="display:none; padding:1rem; border:2px dashed #ccc; margin-top:1rem;">
  <h3>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®š</h3>
  <label>å­¦å¹´:
    <select id="profile-grade">
      <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
      <option value="ä¸­1">ä¸­1</option>
      <option value="ä¸­2">ä¸­2</option>
      <option value="ä¸­3">ä¸­3</option>
    </select>
  </label>
  <br><br>
  <label for="profile-icon-input">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒï¼š</label>
  <input type="file" id="profile-icon-input">

  <script>
  document.getElementById("profile-icon-input").addEventListener("change", () => {
    const file = document.getElementById("profile-icon-input").files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = e => {
        let imgPreview = document.getElementById("icon-preview");
        if (!imgPreview) {
          imgPreview = document.createElement("img");
          imgPreview.id = "icon-preview";
          imgPreview.style.borderRadius = "50%";
          document.getElementById("profile-icon-input").parentNode.appendChild(imgPreview);
        }
        imgPreview.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }
  });
</script>



  <br><br>
  <button id="save-profile-btn">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ä¿å­˜</button>

  <script>
  // ã€Œãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ä¿å­˜ã€ãƒœã‚¿ãƒ³å‡¦ç†ä¾‹
  
</script>

  <p id="profile-setup-message" style="color:red;"></p>
</div>


<div id="app-container" style="display:none;">
  <div id="gear" title="è¨­å®šâš™ï¸">âš™ï¸</div>

  <div id="welcome-msg"></div>

  <!-- ã“ã“ã«ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã¨ãŠã™ã™ã‚å•é¡Œã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ  -->
  <div id="ranking-section" style="margin-bottom: 1rem;">
    <h3>ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆã‚°ãƒƒãƒ‰æ•°é †ï¼‰</h3>
    <div id="ranking-cards" style="display: flex; gap: 1rem; flex-wrap: wrap;"></div>
  </div>

  <div id="recommended-section" style="margin-bottom: 1rem;">
    <h3>ãŠã™ã™ã‚å•é¡Œ</h3>
    <div id="recommended-posts"></div>
  </div>

  <div id="goal-text" style="display:none;">
ã“ã‚“ã«ã¡ã¯ï¼ï¼ˆãƒ­ã‚°ã‚¤ãƒ³åï¼‰ã•ã‚“ï¼
ã“ã®webã‚¢ãƒ—ãƒªã¯å­¦æ ¡ã®å­¦åŠ›ã‚’ä¸Šã’ã‚‹ãŸã‚ã€åŠ©ã‘åˆã„ã€æ•™ãˆåˆã†æ²ç¤ºæ¿ã§ã™ã€‚
ã¿ã‚“ãªãŒå…±æœ‰ã—ã¦ã„ãŸã ãã¨ã‚ã‚ŠãŒãŸã„ã§ã™ã€‚
  </div>

  <div id="filter-section">
    <select id="subject-filter" title="æ•™ç§‘ã§çµã‚‹">
      <option value="">ã™ã¹ã¦ã®æ•™ç§‘</option>
      <option value="æ•°å­¦">æ•°å­¦</option>
      <option value="å›½èª">å›½èª</option>
      <option value="ç†ç§‘">ç†ç§‘</option>
      <option value="ç¤¾ä¼š">ç¤¾ä¼š</option>
      <option value="è‹±èª">è‹±èª</option>
      <option value="ãã®ä»–">ãã®ä»–</option>
    </select>
    <input type="text" id="search-input" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢" title="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢" />
    <button id="search-btn">æ¤œç´¢</button>
    <button id="reset-search-btn">ãƒªã‚»ãƒƒãƒˆ</button>
    <p id="search-message"></p>
  </div>

  <select id="sort-select" title="ä¸¦ã³é †ã§ã‚½ãƒ¼ãƒˆ">
  <option value="goodDesc">ã‚°ãƒƒãƒ‰æ•°é †ï¼ˆå¤šã„é †ï¼‰</option>
  <option value="newest">æ–°ã—ã„é †</option>
  <option value="oldest">å¤ã„é †</option>
</select>


  <div id="post-form">
    <h3>æ–°ã—ã„æŠ•ç¨¿</h3>
    <select id="post-subject">
      <option value="æ•°å­¦">æ•°å­¦</option>
      <option value="å›½èª">å›½èª</option>
      <option value="ç†ç§‘">ç†ç§‘</option>
      <option value="ç¤¾ä¼š">ç¤¾ä¼š</option>
      <option value="è‹±èª">è‹±èª</option>
      <option value="ãã®ä»–">ãã®ä»–</option>
    </select>
    <textarea id="post-input" placeholder="è³ªå•ã‚„äºˆæƒ³å•é¡Œã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea><br />
    <input type="file" id="post-image-input" accept="image/*" />
    <button id="post-btn">æŠ•ç¨¿ã™ã‚‹</button>
    <p id="post-message"></p>
  </div>

  <div id="posts"></div>
</div>

<div id="side-panel" aria-hidden="true">
  <h3>è¨­å®šãƒ¡ãƒ‹ãƒ¥ãƒ¼</h3>
  <button id="toggle-goal-btn">ç›®æ¨™éè¡¨ç¤º</button>
  <button id="edit-profile-btn">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†</button>
  <button disabled>é‹å–¶ã¸ã®è³ªå•ãƒ»ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆæœªå®Ÿè£…ï¼‰</button>
  <button disabled>è¨­å®šï¼ˆæœªå®Ÿè£…ï¼‰</button>
  <button id="toggle-darkmode-btn">ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ON</button>
  <button id="logout-btn" style="margin-top:2rem; background:#c62828;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
</div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

  <script>
  // ã“ã“ã‚’ã‚ãªãŸã®Firebaseè¨­å®šã«æ›¸ãæ›ãˆã¦ãã ã•ã„
  const firebaseConfig = {
  apiKey: "AIzaSyBfstQdl-avHfBWaiPkC0Bzwm_9apWe6Mo",
  authDomain: "school-board-e2ee2.firebaseapp.com",
  projectId: "school-board-e2ee2",
storageBucket: "school-board-e2ee2.appspot.com",
  messagingSenderId: "257360614407",
  appId: "1:257360614407:web:7cdae33b9ac7d7a671c6a2"
};


  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const storage = firebase.storage();

  // UIè¦ç´ å–å¾—
  const profileSetupDiv = document.getElementById("profile-setup");
  const profileGrade = document.getElementById("profile-grade");
  const profileIconInput = document.getElementById("profile-icon-input");
  const saveProfileBtn = document.getElementById("save-profile-btn");
  const profileMsg = document.getElementById("profile-setup-message");
  const loginContainer = document.getElementById("login-container");
  const appContainer = document.getElementById("app-container");
  const loginMessage = document.getElementById("login-message");
  const welcomeMsg = document.getElementById("welcome-msg");
  const postInput = document.getElementById("post-input");
  const postBtn = document.getElementById("post-btn");
  const postsDiv = document.getElementById("posts");
  const gearBtn = document.getElementById("gear");
  const sidePanel = document.getElementById("side-panel");
  const toggleGoalBtn = document.getElementById("toggle-goal-btn");
  const goalText = document.getElementById("goal-text");
  const logoutBtn = document.getElementById("logout-btn");
  const postSubject = document.getElementById("post-subject");
  const postImageInput = document.getElementById("post-image-input");
  const subjectFilter = document.getElementById("subject-filter");
  const searchInput = document.getElementById("search-input");
  const searchBtn = document.getElementById("search-btn");
  const resetSearchBtn = document.getElementById("reset-search-btn");
  const searchMessage = document.getElementById("search-message");
  const postMessage = document.getElementById("post-message");

  // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ»ãŠã™ã™ã‚è¡¨ç¤ºç”¨è¦ç´ 
  const recommendedPostsDiv = document.getElementById("recommended-posts");
  const rankingCardsDiv = document.getElementById("ranking-cards");

  function renderRanking() {
  rankingCardsDiv.innerHTML = "";
  const sorted = [...posts]
    .sort((a,b) => (b.goodCount || 0) - (a.goodCount || 0))
    .slice(0, 3);

  sorted.forEach(post => {
    const card = document.createElement("div");
    card.className = "ranking-card";   // â† class ã‚’ä»˜ä¸
    card.innerHTML = `
      <div style="font-weight:bold;margin-bottom:0.4rem;">${escapeHTML(post.subject)}</div>
      <div style="flex:1;">${escapeHTML(post.content).slice(0, 50)}...</div>
      <div style="margin-top:0.4rem;font-size:0.8rem;">ğŸ‘ ${post.goodCount || 0} ã‚°ãƒƒãƒ‰</div>
    `;
    rankingCardsDiv.appendChild(card);
  });
}

  function renderRecommendedPosts() {
  recommendedPostsDiv.innerHTML = ""; // â† h3ã‚’å«ã‚ãªã„
  const recommended = posts.filter(p => (p.goodCount || 0) >= 3).slice(0, 3);
  if (recommended.length === 0) {
    recommendedPostsDiv.innerHTML += "<p>ãŠã™ã™ã‚æŠ•ç¨¿ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</p>";
    return;
  }
  recommended.forEach(post => {
    const div = document.createElement("div");
    div.style = "padding:0.8rem;margin-bottom:0.5rem;background:#f1f8e9;border-radius:6px;";
    div.innerHTML = `
      <strong>${escapeHTML(post.subject)}</strong>: ${escapeHTML(post.content).slice(0, 80)}...<br>
      ğŸ‘ ${post.goodCount || 0} ã‚°ãƒƒãƒ‰
    `;
    recommendedPostsDiv.appendChild(div);
  });
}

  

  let posts = [];
  let goalVisible = true;
  let openReplyForms = {};
  let darkMode = false;

  // ã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ«é–‹é–‰
  gearBtn.addEventListener("click", () => {
    if (sidePanel.classList.contains("open")) {
      sidePanel.classList.remove("open");
      sidePanel.setAttribute("aria-hidden", "true");
    } else {
      sidePanel.classList.add("open");
      sidePanel.setAttribute("aria-hidden", "false");
    }
  });

  // ç›®æ¨™è¡¨ç¤ºåˆ‡æ›¿
  toggleGoalBtn.addEventListener("click", () => {
    goalVisible = !goalVisible;
    goalText.style.display = goalVisible ? "block" : "none";
    toggleGoalBtn.textContent = goalVisible ? "ç›®æ¨™éè¡¨ç¤º" : "ç›®æ¨™è¡¨ç¤º";
  });

  //ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿
  const toggleDarkBtn = document.getElementById("toggle-darkmode-btn");
  darkMode = false

  toggleDarkBtn.addEventListener("click", () => {
  darkMode = !darkMode;
  document.body.classList.toggle("dark-mode", darkMode);
  toggleDarkBtn.textContent = darkMode ? "ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰OFF" : "ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ON";
});


  // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
  logoutBtn.addEventListener("click", () => {
    auth.signOut();
  });

  const sortSelect = document.getElementById("sort-select");

  sortSelect.addEventListener("change", () => {
   renderPosts();
  });


  // æŠ•ç¨¿è¡¨ç¤ºã‚’æç”»
  function renderPosts() {
  postsDiv.innerHTML = "";
  let filtered = posts.filter(post => {
    const matchSubject = subjectFilter.value === "" || post.subject === subjectFilter.value;
    const keyword = searchInput.value.trim().toLowerCase();
    const matchKeyword = keyword === "" || post.content.toLowerCase().includes(keyword) || post.userName.toLowerCase().includes(keyword);
    return matchSubject && matchKeyword;
  });

  // é¸æŠã•ã‚ŒãŸã‚½ãƒ¼ãƒˆåŸºæº–ã‚’å–å¾—
  const sortType = sortSelect.value;

  // ã‚½ãƒ¼ãƒˆ
  filtered.sort((a, b) => {
    if (sortType === "goodDesc") {
      return (b.goodCount || 0) - (a.goodCount || 0) || (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0);
    } else if (sortType === "newest") {
      return (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0);
    } else if (sortType === "oldest") {
      return (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0);
    }
    return 0;
  });

  filtered.forEach(post => {
    postsDiv.appendChild(createPostElement(post));
  });
}


  // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
  function escapeHTML(str) {
    if (!str) return "";
    return str.replace(/[&<>"']/g, c => ({
      '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
    })[c]);
  }

  // æŠ•ç¨¿è¦ç´ ä½œæˆ
  function createPostElement(post) {
  const div = document.createElement("div");
  div.className = "post";
  div.dataset.id = post.id;

  // ã‚°ãƒƒãƒ‰ãƒœã‚¿ãƒ³ã®ã‚¯ãƒ©ã‚¹
  let goodClass = "btn-good";
  if (post.userGoodIds && post.userGoodIds.includes(auth.currentUser.uid)) goodClass += " active";

  // å‰Šé™¤ãƒœã‚¿ãƒ³ã¯è‡ªåˆ†ã®æŠ•ç¨¿ã®ã¿è¡¨ç¤º
  const canDelete = post.userId === auth.currentUser.uid;

  let html = `
  <div class="post-header" style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.5rem;">
    <img src="${escapeHTML(post.userIconUrl || 'https://upload.wikimedia.org/wikipedia/commons/9/99/Sample_User_Icon.png')}" 
         alt="ã‚¢ã‚¤ã‚³ãƒ³" 
         style="width:36px;height:36px;border-radius:50%;">
    <div>
      <div><strong>${escapeHTML(post.userName)}</strong>ï¼ˆ${escapeHTML(post.userGrade || 'æœªè¨­å®š')}ï¼‰</div>
      <div style="font-size:0.8rem;color:#555;">${post.createdAt ? new Date(post.createdAt.seconds * 1000).toLocaleString() : ""}</div>
    </div>
  </div>
  <div><strong>æ•™ç§‘ï¼š</strong>${escapeHTML(post.subject)}</div>
  <div class="content">${escapeHTML(post.content)}</div>
`;


  if (post.imageUrl) {
    html += `<img src="${escapeHTML(post.imageUrl)}" alt="æŠ•ç¨¿ç”»åƒ" class="post-image">`;
  }

  html += `
    <div class="post-footer">
      æŠ•ç¨¿è€…: ${escapeHTML(post.userName)} | æ—¥æ™‚: ${post.createdAt ? new Date(post.createdAt.seconds * 1000).toLocaleString() : ""} |
      <span class="${goodClass}" title="ã‚°ãƒƒãƒ‰" style="margin-left:1rem;">ğŸ‘ <span class="good-count">${post.goodCount || 0}</span></span>
      <button class="reply-btn" style="margin-left:1rem;">è¿”ä¿¡</button>
      ${canDelete ? `<button class="delete-btn" style="margin-left:1rem; background:#c62828; color:#fff; border:none; padding:4px 8px; border-radius:4px; cursor:pointer;">å‰Šé™¤</button>` : ""}
      <span class="reply-count" id="reply-count-${post.id}" style="margin-left:1rem; cursor:pointer; color: blue; text-decoration: underline;">ğŸ’¬ ...ä»¶ã®è¿”ä¿¡</span>
    </div>
    <div class="reply-container" style="display:none;"></div>
  `;

  div.innerHTML = html;

  // ã‚°ãƒƒãƒ‰ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
  const goodBtn = div.querySelector(".btn-good");
  if (!goodBtn.classList.contains("disabled")) {
    goodBtn.addEventListener("click", () => toggleGood(post.id, null));
  }

  // è¿”ä¿¡ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
  const replyBtn = div.querySelector(".reply-btn");
  const replyContainer = div.querySelector(".reply-container");
  replyBtn.addEventListener("click", () => toggleReplyForm(post.id, replyContainer));

  // å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
  if (canDelete) {
    const deleteBtn = div.querySelector(".delete-btn");
    deleteBtn.addEventListener("click", async () => {
      if (!confirm("ã“ã®æŠ•ç¨¿ã¨è¿”ä¿¡ã‚’æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
      try {
        const repliesSnapshot = await db.collection("replies").where("postId", "==", post.id).get();
        const batch = db.batch();
        repliesSnapshot.forEach(doc => batch.delete(doc.ref));
        batch.delete(db.collection("posts").doc(post.id));
        await batch.commit();
        fetchPosts();
      } catch (e) {
        alert("å‰Šé™¤ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
        console.error(e);
      }
    });
  }

  // è¿”ä¿¡æ•°ã‚’å–å¾—ã—ã¦è¡¨ç¤º
  db.collection("replies").where("postId", "==", post.id).get().then(snapshot => {
    const count = snapshot.size;
    const countSpan = div.querySelector(`#reply-count-${post.id}`);
    if (countSpan) countSpan.textContent = `ğŸ’¬ ${count}ä»¶ã®è¿”ä¿¡`;
  });

  // è¿”ä¿¡æ•°ã‚¯ãƒªãƒƒã‚¯ã§è¿”ä¿¡è¡¨ç¤ºåˆ‡æ›¿
  const replyCountSpan = div.querySelector(`#reply-count-${post.id}`);
  replyCountSpan.addEventListener("click", () => {
    if (replyContainer.style.display === "none") {
      replyContainer.style.display = "block";
      // è¿”ä¿¡ã‚’èª­ã¿è¾¼ã¿ï¼ˆé–‹ããŸã³ã«æœ€æ–°åŒ–ã—ãŸã„å ´åˆï¼‰
      loadReplies(post.id, replyContainer);
    } else {
      replyContainer.style.display = "none";
    }
  });

  // è¿”ä¿¡èª­ã¿è¾¼ã¿ï¼ˆåˆæœŸã¯éè¡¨ç¤ºãªã®ã§èª­ã¿è¾¼ã¿ã¯ã‚¯ãƒªãƒƒã‚¯å¾Œã«ï¼‰
  // loadReplies(post.id, replyContainer);

  return div;
}




  // è¿”ä¿¡è¦ç´ ä½œæˆ
  function createReplyElement(reply, postId) {
  const div = document.createElement("div");
  div.className = "reply";
  div.dataset.id = reply.id;

  let goodClass = "btn-good";
  if (reply.userGoodIds && reply.userGoodIds.includes(auth.currentUser.uid)) goodClass += " disabled";

  // è‡ªåˆ†ã®è¿”ä¿¡ãªã‚‰å‰Šé™¤ãƒœã‚¿ãƒ³è¡¨ç¤º
  const canDelete = reply.userId === auth.currentUser.uid;

  let html = `
  <div class="content">${escapeHTML(reply.content)}</div>
`;
if (reply.imageUrl) {
  html += `<img src="${escapeHTML(reply.imageUrl)}" alt="è¿”ä¿¡ç”»åƒ" class="reply-image">`;
}

html += `
  <div class="reply-footer">
    æŠ•ç¨¿è€…: ${escapeHTML(reply.userName)} | æ—¥æ™‚: ${reply.createdAt ? new Date(reply.createdAt.seconds * 1000).toLocaleString() : ""}
    <span class="${goodClass}" title="ã‚°ãƒƒãƒ‰" style="margin-left:1rem;">ğŸ‘ <span class="good-count">${reply.goodCount || 0}</span></span>
    ${canDelete ? `<button class="delete-btn" style="margin-left:1rem; background:#c62828; color:#fff; border:none; padding:4px 8px; border-radius:4px; cursor:pointer;">å‰Šé™¤</button>` : ""}
  </div>
`;


  div.innerHTML = html;

  // ã‚°ãƒƒãƒ‰ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
  const goodBtn = div.querySelector(".btn-good");
if (goodBtn) {
  goodBtn.addEventListener("click", async () => {
    try {
      const replyDocRef = db.collection("replies").doc(reply.id);
      await db.runTransaction(async (transaction) => {
        const doc = await transaction.get(replyDocRef);
        if (!doc.exists) return;

        const data = doc.data();
        const goodIds = data.userGoodIds || [];
        let goodCount = data.goodCount || 0;

        if (goodIds.includes(auth.currentUser.uid)) {
          // å–ã‚Šæ¶ˆã—
          goodCount--;
          transaction.update(replyDocRef, {
            userGoodIds: goodIds.filter(id => id !== auth.currentUser.uid),
            goodCount
          });
        } else {
          // è¿½åŠ 
          goodCount++;
          transaction.update(replyDocRef, {
            userGoodIds: [...goodIds, auth.currentUser.uid],
            goodCount
          });
        }
      });
      fetchPosts();
    } catch (e) {
      console.error("ã‚°ãƒƒãƒ‰å¤±æ•—:", e);
    }
  });
}

  // å‰Šé™¤ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
  if (canDelete) {
    const deleteBtn = div.querySelector(".delete-btn");
    deleteBtn.addEventListener("click", async () => {
      if (!confirm("ã“ã®è¿”ä¿¡ã‚’æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
      try {
        await db.collection("replies").doc(reply.id).delete();
        fetchPosts();
      } catch (e) {
        alert("å‰Šé™¤ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
        console.error(e);
      }
    });
  }

  return div;
}


  // è¿”ä¿¡ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤ºãƒ»éè¡¨ç¤ºåˆ‡æ›¿
  function toggleReplyForm(postId, container) {
  if (openReplyForms[postId]) {
    openReplyForms[postId].remove();
    delete openReplyForms[postId];
    return;
  }

  // è¿”ä¿¡ãƒ•ã‚©ãƒ¼ãƒ ã‚’ form è¦ç´ ã§ä½œæˆï¼ˆsubmitã‚¤ãƒ™ãƒ³ãƒˆå¯¾å¿œï¼‰
  const form = document.createElement("form");
  form.id = `reply-form-${postId}`;
  form.innerHTML = `
    <textarea name="reply-text" placeholder="è¿”ä¿¡å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" rows="3" style="width:100%;"></textarea>
    <input type="file" name="reply-image" accept="image/*" />
    <button type="submit">è¿”ä¿¡ã‚’é€ä¿¡</button>
    <p style="color:red;" class="reply-message"></p>
  `;

  container.appendChild(form);
  openReplyForms[postId] = form;

  const textarea = form.querySelector("textarea[name=reply-text]");
  const fileInput = form.querySelector("input[name=reply-image]");
  const msgP = form.querySelector(".reply-message");
  const sendBtn = form.querySelector("button[type=submit]");

  // submit ã‚¤ãƒ™ãƒ³ãƒˆã«å¤‰æ›´
  form.addEventListener("submit", async (e) => {
    e.preventDefault(); // ãƒšãƒ¼ã‚¸ãƒªãƒ­ãƒ¼ãƒ‰é˜²æ­¢
    const text = textarea.value.trim();
    if (!text) {
      msgP.textContent = "è¿”ä¿¡å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„";
      return;
    }
    sendBtn.disabled = true;
    msgP.textContent = "";

    try {
      let imageUrl = "";
      if (fileInput.files.length > 0) {
        const file = fileInput.files[0];
        const storageRef = storage.ref();
        const fileRef = storageRef.child(`replies/${postId}/${Date.now()}_${file.name}`);
        await fileRef.put(file);
        imageUrl = await fileRef.getDownloadURL();
      }
      await db.collection("replies").add({
        postId: postId,
        userId: auth.currentUser.uid,
        userName: auth.currentUser.displayName || auth.currentUser.email.split("@")[0],
        content: text,
        imageUrl: imageUrl,
        goodCount: 0,
        userGoodIds: [],
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      textarea.value = "";
      fileInput.value = "";
      msgP.style.color = "green";
      msgP.textContent = "è¿”ä¿¡ã‚’é€ä¿¡ã—ã¾ã—ãŸ";
      form.remove();
      delete openReplyForms[postId];
      fetchPosts();
    } catch (e) {
      console.error(e);
      msgP.style.color = "red";
      msgP.textContent = "é€ä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ";
    }
    sendBtn.disabled = false;
  });
}


  // è¿”ä¿¡èª­ã¿è¾¼ã¿
  async function loadReplies(postId, container) {
    container.innerHTML = "è¿”ä¿¡ã‚’èª­ã¿è¾¼ã¿ä¸­...";
    try {
      const querySnapshot = await db.collection("replies")
        .where("postId", "==", postId)
        .orderBy("createdAt", "asc")
        .get();
      container.innerHTML = "";
      querySnapshot.forEach(doc => {
        const reply = {id: doc.id, ...doc.data()};
        container.appendChild(createReplyElement(reply, postId));
      });
    } catch(e) {
      container.innerHTML = "è¿”ä¿¡ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ";
      console.error(e);
    }
  }

  // ã‚°ãƒƒãƒ‰ãƒœã‚¿ãƒ³åˆ‡æ›¿ï¼ˆæŠ•ç¨¿orè¿”ä¿¡ï¼‰
  async function toggleGood(postId, replyId) {
    const uid = auth.currentUser.uid;
    let docRef;

    if (replyId === null) {
      docRef = db.collection("posts").doc(postId);
    } else {
      docRef = db.collection("replies").doc(replyId);
    }

    try {
      await db.runTransaction(async (transaction) => {
        const doc = await transaction.get(docRef);
        if (!doc.exists) throw "ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒå­˜åœ¨ã—ã¾ã›ã‚“";

        let docData = doc.data();
        let userGoodIds = docData.userGoodIds || [];
        let goodCount = docData.goodCount || 0;

        if (userGoodIds.includes(uid)) {
          userGoodIds = userGoodIds.filter(id => id !== uid);
          goodCount--;
        } else {
          userGoodIds.push(uid);
          goodCount++;
        }
        transaction.update(docRef, {
          userGoodIds: userGoodIds,
          goodCount: goodCount
        });
      });
      fetchPosts();
    } catch(e) {
      console.error("ã‚°ãƒƒãƒ‰æ›´æ–°ã‚¨ãƒ©ãƒ¼:", e);
    }
  }

  // æŠ•ç¨¿é€ä¿¡
  postBtn.addEventListener("click", async () => {
  const content = postInput.value.trim();
  const subject = postSubject.value;
  const file = postImageInput.files[0];
  postMessage.textContent = "";

  if (!content) {
    postMessage.textContent = "å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„";
    return;
  }

  postBtn.disabled = true;
  postMessage.style.color = "green";
  postMessage.textContent = "æŠ•ç¨¿ã‚’å‡¦ç†ä¸­ã§ã™â€¦ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„";

  try {
    let imageUrl = "";
    if (file) {
      const storageRef = storage.ref();
      const fileRef = storageRef.child(`posts/${auth.currentUser.uid}/${Date.now()}_${file.name}`);
      await fileRef.put(file);
      imageUrl = await fileRef.getDownloadURL();
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã‚’å–å¾—
    const userDoc = await db.collection("users").doc(auth.currentUser.uid).get();
    const userData = userDoc.data() || {};

    await db.collection("posts").add({
      userId: auth.currentUser.uid,
      userName: auth.currentUser.displayName || auth.currentUser.email.split("@")[0],
      subject,
      content,
      imageUrl,
      goodCount: 0,
      userGoodIds: [],
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      userGrade: userData.grade || "æœªè¨­å®š",
      userIconUrl: userData.iconUrl || "" // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®äººå½±ã§ã‚‚OK
    });

    postInput.value = "";
    postImageInput.value = "";
    postMessage.textContent = "æŠ•ç¨¿ã•ã‚Œã¾ã—ãŸï¼";
    fetchPosts();

  } catch (e) {
    console.error(e);
    postMessage.style.color = "red";
    postMessage.textContent = "æŠ•ç¨¿ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ";
  }

  postBtn.disabled = false;
});



  // æŠ•ç¨¿å–å¾—ã¨æç”»
async function fetchPosts() {
try {
const snapshot = await db.collection("posts").get();
posts = [];
snapshot.forEach(doc => {
posts.push({ id: doc.id, ...doc.data() });
});
renderPosts(); // æŠ•ç¨¿ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
renderRanking(); // ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º
renderRecommendedPosts(); // ãŠã™ã™ã‚æŠ•ç¨¿è¡¨ç¤º
} catch(e) {
console.error(e);
}
}

  // æ¤œç´¢ã¨ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®ã‚¤ãƒ™ãƒ³ãƒˆ
  searchBtn.addEventListener("click", () => {
    searchMessage.textContent = "";
    renderPosts();
  });
  resetSearchBtn.addEventListener("click", () => {
    subjectFilter.value = "";
    searchInput.value = "";
    searchMessage.textContent = "";
    renderPosts();
  });
  subjectFilter.addEventListener("change", () => {
    renderPosts();
  });

  const editProfileBtn = document.getElementById("edit-profile-btn");

editProfileBtn.addEventListener("click", async () => {
  profileSetupDiv.style.display = "block";
  appContainer.style.display = "none";

  try {
    const userDoc = await db.collection("users").doc(auth.currentUser.uid).get();
    if (userDoc.exists) {
      const data = userDoc.data();
      profileGrade.value = data.grade || "";
      // ç”»åƒã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°ãªã©ã‚‚ã“ã“ã§å¯èƒ½ï¼ˆå¿…è¦ãªã‚‰è¿½åŠ ï¼‰
    }
  } catch (e) {
    console.error("ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—å¤±æ•—:", e);
  }
});


  // èªè¨¼çŠ¶æ…‹ç›£è¦–
  auth.onAuthStateChanged(async (user) => {
  if (user) {
    // displayName ãŒãªã‘ã‚Œã°ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã•ã›ã‚‹
    if (!user.displayName) {
      const userName = prompt("ã“ã‚“ã«ã¡ã¯ï¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
      if (userName) {
        await user.updateProfile({ displayName: userName });
        // å†èª­ã¿è¾¼ã¿ã—ãªãã¦ã‚‚è¡¨ç¤ºæ›´æ–°
        welcomeMsg.textContent = `ã“ã‚“ã«ã¡ã¯ï¼${userName}ã•ã‚“ï¼`;
        goalText.innerHTML = `ã“ã‚“ã«ã¡ã¯ï¼${userName}ã•ã‚“ï¼<br>ã“ã®webã‚¢ãƒ—ãƒªã¯å­¦æ ¡ã®å­¦åŠ›ã‚’ä¸Šã’ã‚‹ãŸã‚ã€åŠ©ã‘åˆã„ã€æ•™ãˆåˆã†æ²ç¤ºæ¿ã§ã™ã€‚ã¿ã‚“ãªãŒå…±æœ‰ã—ã¦ã„ãŸã ãã¨ã‚ã‚ŠãŒãŸã„ã§ã™ã€‚`;
      }
    } else {
      welcomeMsg.textContent = `ã“ã‚“ã«ã¡ã¯ï¼${user.displayName}ã•ã‚“ï¼`;
      goalText.innerHTML = `ã“ã‚“ã«ã¡ã¯ï¼${user.displayName}ã•ã‚“ï¼<br>ã“ã®webã‚¢ãƒ—ãƒªã¯å­¦æ ¡ã®å­¦åŠ›ã‚’ä¸Šã’ã‚‹ãŸã‚ã€åŠ©ã‘åˆã„ã€æ•™ãˆåˆã†æ²ç¤ºæ¿ã§ã™ã€‚ã¿ã‚“ãªãŒå…±æœ‰ã—ã¦ã„ãŸã ãã¨ã‚ã‚ŠãŒãŸã„ã§ã™ã€‚`;
    }
    goalText.style.display = goalVisible ? "block" : "none";
    toggleGoalBtn.textContent = goalVisible ? "ç›®æ¨™éè¡¨ç¤º" : "ç›®æ¨™è¡¨ç¤º";
    loginContainer.style.display = "none";
    appContainer.style.display = "block";

const userDoc = await db.collection("users").doc(user.uid).get();
if (!userDoc.exists || !userDoc.data().grade || !userDoc.data().iconUrl) {
  appContainer.style.display = "none";
  profileSetupDiv.style.display = "block";
} else {
  profileSetupDiv.style.display = "none";
  appContainer.style.display = "block";
  fetchPosts();
}

  } else {
    loginContainer.style.display = "block";
    appContainer.style.display = "none";
  }
});


  // ãƒ­ã‚°ã‚¤ãƒ³ãƒ»æ–°è¦ç™»éŒ²UIï¼ˆç°¡æ˜“ç‰ˆï¼‰
  const loginBtn = document.getElementById("login-btn");
  const signupBtn = document.getElementById("signup-btn");

  loginBtn.addEventListener("click", async () => {
    loginMessage.textContent = "";
    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value;
    if (!email || !password) {
      loginMessage.textContent = "ãƒ¡ãƒ¼ãƒ«ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„";
      return;
    }
    try {
      await auth.signInWithEmailAndPassword(email, password);
    } catch(e) {
      loginMessage.textContent = "ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—ï¼š" + e.message;
    }
  });

  signupBtn.addEventListener("click", async () => {
  loginMessage.textContent = "";
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value;
  const username = document.getElementById("username").value.trim();

  if (!email || !password || !username) {
    loginMessage.textContent = "ãƒ¡ãƒ¼ãƒ«ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’ã™ã¹ã¦å…¥åŠ›ã—ã¦ãã ã•ã„";
    return;
  }

  try {
    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
    await userCredential.user.updateProfile({ displayName: username });

    // Firestore ã«åˆæœŸãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã‚’ä¿å­˜ï¼ˆgrade/iconUrlã¯å¾Œã§è¨­å®šï¼‰
    await db.collection("users").doc(userCredential.user.uid).set({
      grade: "",         // åˆæœŸã¯ç©ºã€ã‚ã¨ã§è¨­å®š
      iconUrl: ""        // åˆæœŸã¯ç©ºã€ã‚ã¨ã§è¨­å®š
    });

    loginMessage.style.color = "green";
    loginMessage.textContent = "æ–°è¦ç™»éŒ²ã«æˆåŠŸã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã§ã™...";

  } catch (e) {
    console.error(e);
    loginMessage.style.color = "red";
    loginMessage.textContent = "ç™»éŒ²ã‚¨ãƒ©ãƒ¼ï¼š" + e.message;
  }
});

saveProfileBtn.addEventListener("click", async () => {
  const grade = profileGrade.value;
  const file = profileIconInput.files[0];

  if (!grade) {
    profileMsg.textContent = "å­¦å¹´ã‚’é¸æŠã—ã¦ãã ã•ã„";
    return;
  }

  saveProfileBtn.disabled = true;
  profileMsg.textContent = "";

  let iconUrl = "https://upload.wikimedia.org/wikipedia/commons/7/7c/Profile_avatar_placeholder_large.png";

  try {
    if (file) {
      const fileRef = storage.ref().child(`icons/${auth.currentUser.uid}/${Date.now()}_${file.name}`);
      await fileRef.put(file);
      iconUrl = await fileRef.getDownloadURL();
    }

    // update ã‚’ set ã«å¤‰æ›´ã€ãƒãƒ¼ã‚¸ãƒ¢ãƒ¼ãƒ‰ã§ä¸Šæ›¸ãã—ãªã„
    await db.collection("users").doc(auth.currentUser.uid).set({
      grade,
      iconUrl
    }, { merge: true });

    profileSetupDiv.style.display = "none";
    appContainer.style.display = "block";
    fetchPosts();
  } catch (e) {
    profileMsg.textContent = "ä¿å­˜ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ";
    console.error(e);
  }

  saveProfileBtn.disabled = false;
});


</script>
</body>
</html>
